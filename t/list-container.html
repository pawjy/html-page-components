<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Test</title>
  <style>
    .display-block {
      display: block;
    }
  </style>
</head>
<body>
  <test-code name="no loader">
    // <list-container key=dummy>hoge</list-container>
    var e = this.currentScript.querySelector ('list-container');
    this.assert.equal (e.innerHTML, 'hoge');
  </test-code>
  
  <test-code name="loader not defined">
    // <list-container loader=abcde>hoge</list-container>
    var e = this.currentScript.querySelector ('list-container');
    this.assert.equal (e.innerHTML, 'hoge');
  </test-code>
  
  <test-code name="loader defined after upgrade">
    /*
      <list-container loader=loaderDefinedAfterUpgrade>
        <template><span data-field=name></span></template>
        <list-main></list-main>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    var handler = document.createElementNS ('data:,pc', 'loader');
    handler.setAttribute ('name', 'loaderDefinedAfterUpgrade');
    handler.pcHandler = () => {
      return {data: [{"name":"a"}, {"name":"c"}]};
    };
    document.head.appendChild (handler);
    return this.wait (100).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, 'a');
      this.assert.equal (items[1].textContent, 'c');
    });
  </test-code>
  
  <test-code name="loader defined before upgrade">
    /*
      <template>
        <template><span data-field=name></span></template>
        <list-main></list-main>
      </template>
    */
    var handler = document.createElementNS ('data:,pc', 'loader');
    handler.setAttribute ('name', 'loaderDefinedBeforeUpgrade');
    handler.pcHandler = () => {
      return {data: [{"name":"a"}, {"name":"c"}]};
    };
    document.head.appendChild (handler);

    var e = document.createElement ('list-container');
    e.setAttribute ('loader', 'loaderDefinedBeforeUpgrade');
    var f = this.currentScript.querySelector ('template');
    e.appendChild (f.content);
    this.currentScript.appendChild (e);
    
    return this.wait (100).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, 'a');
      this.assert.equal (items[1].textContent, 'c');
    });
  </test-code>
  
  <test-code name="list-main inserted later">
    /*
      <template>
        <template><span data-field=name></span></template>
      </template>
    */
    var handlerName = Math.random ();
    var handler = document.createElementNS ('data:,pc', 'loader');
    handler.setAttribute ('name', handlerName);
    handler.pcHandler = () => {
      return {data: [{"name":"aa"}, {"name":"cc"}]};
    };
    document.head.appendChild (handler);

    var e = document.createElement ('list-container');
    e.setAttribute ('loader', handlerName);
    var f = this.currentScript.querySelector ('template');
    e.appendChild (f.content);
    this.currentScript.appendChild (e);
    
    return this.wait ().then (() => {
      var insertionPoint = document.createElement ('list-main');
      e.appendChild (insertionPoint);
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, 'aa');
      this.assert.equal (items[1].textContent, 'cc');
    });
  </test-code>
  
  <test-code name="list-main inserted later (descendant)">
    /*
      <template>
        <template>[[<span data-field=name></span>]]</template>
      </template>
    */
    var handlerName = Math.random ();
    var handler = document.createElementNS ('data:,pc', 'loader');
    handler.setAttribute ('name', handlerName);
    handler.pcHandler = () => {
      return {data: [{"name":"aa"}, {"name":"cc"}]};
    };
    document.head.appendChild (handler);

    var e = document.createElement ('list-container');
    e.setAttribute ('loader', handlerName);
    var f = this.currentScript.querySelector ('template');
    e.appendChild (f.content);
    this.currentScript.appendChild (e);
    
    return this.wait ().then (() => {
      var insertionPoint = document.createElement ('list-main');
      var g = document.createElement ('div');
      g.appendChild (insertionPoint);
      e.appendChild (g);
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '[[aa]]');
      this.assert.equal (items[1].textContent, '[[cc]]');
    });
  </test-code>
  
  <test-code name="renderingrequires filltype">
    /*
      <list-container loader=renderingRequiresTestLoader>
        <template data-requires=filltype:e-1><e-1 data-field=name></e-1></template>
        <list-main></list-main>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    var handler = document.createElementNS ('data:,pc', 'loader');
    handler.setAttribute ('name', 'renderingRequiresTestLoader');
    handler.pcHandler = () => {
      return {data: [{"name":"a"}, {"name":"c"}]};
    };
    document.head.appendChild (handler);

    return this.wait (100).then (() => {
      var f = document.createElementNS ('data:,pc', 'filltype');
      f.setAttribute ('name', 'e-1');
      f.setAttribute ('content', 'contentattribute');
      document.head.appendChild (f);
      
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '');
      this.assert.equal (items[0].firstChild.getAttribute ('value'), 'a', 'value=""');
      this.assert.equal (items[1].textContent, '');
      this.assert.equal (items[1].firstChild.getAttribute ('value'), 'c', 'value=""');
    });
  </test-code>
  
  <test-code name="src">
    /*
      <list-container src=list-container-data-1.json key=abc>
        <template><span data-field=name></span></template>
        <list-main></list-main>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    return this.wait ().then (() => {
      return e.loaded;
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, 'A.');
      this.assert.equal (items[1].textContent, 'B.');
    });
  </test-code>
  
  <test-code name="src no key">
    /*
      <list-container src=list-container-data-1.json>
        <template><span data-field=name></span></template>
        <list-main></list-main>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    return this.wait ().then (() => {
      return e.loaded;
    }).then (() => {
      throw "e.loaded not failed";
    }, (error) => {  
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 0);
      this.assertEqualError (error, new Error ("|key| is not specified"));
    });
  </test-code>
  
  <test-code name="src bad json">
    /*
      <list-container src=data:,null key=abc>
        <template><span data-field=name></span></template>
        <list-main></list-main>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    return this.wait ().then (() => {
      return e.loaded.catch ((e) => { });
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 0);
    });
    <!-- XXX action-status integration -->
  </test-code>

  <script>
    var handler = document.createElementNS ('data:,pc', 'loader');
    handler.setAttribute ('name', 'pagingLoader');
    handler.pcHandler = (opts) => {
      var ref = parseFloat (opts.ref);
      if (!Number.isFinite (ref)) ref = 0;
      return {
        data: [{"value":++ref}, {"value": ++ref}],
        next: {ref: ref, has: true},
        prev: {ref: ref-8, has: false},
      };
    };
    document.head.appendChild (handler);
  </script>
  <script>
    var handler = document.createElementNS ('data:,pc', 'loader');
    handler.setAttribute ('name', 'pagingNoPageLoader');
    handler.pcHandler = (opts) => {
      var ref = parseFloat (opts.ref);
      if (!Number.isFinite (ref)) ref = 0;
      return {
        data: [{"value":++ref}, {"value": ++ref}],
      };
    };
    document.head.appendChild (handler);
  </script>

  <script>
    var handler = document.createElementNS ('data:,pc', 'loader');
    handler.setAttribute ('name', 'pagingAppendLoader');
    handler.pcHandler = (opts) => {
      var ref = parseFloat (opts.ref);
      if (!Number.isFinite (ref)) ref = 0;
      return {
        data: [{"value":++ref}, {"value": ++ref}],
        next: {ref: ref, has: true, append: true},
        prev: {ref: ref-4, has: false, prepend: true},
      };
    };
    document.head.appendChild (handler);
  </script>
  
  <test-code name="paging">
    /*
      <list-container loader=pagingLoader key=data>
        <template><span data-field=value></span></template>
        <list-main></list-main>
        <a class=list-next data-list-replace>Next</a>
        <a class=list-prev data-list-replace>Prev</a>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    var n = this.currentScript.querySelector ('.list-next');
    var p = this.currentScript.querySelector ('.list-prev');
    return this.wait (100).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '1');
      this.assert.equal (items[1].textContent, '2');
      this.assert.equal (n.href, 'javascript:');
      this.assert.equal (n.hidden, false);
      this.assert.equal (p.href, 'javascript:');
      this.assert.equal (p.hidden, true);
      n.click ();
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '3');
      this.assert.equal (items[1].textContent, '4');
      p.click ();
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '-3');
      this.assert.equal (items[1].textContent, '-2');
      p.click ();
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '-1');
      this.assert.equal (items[1].textContent, '0');
    });
  </test-code>
  
  <test-code name="paging no page data">
    /*
      <list-container loader=pagingNoPageLoader key=data>
        <template><span data-field=value></span></template>
        <list-main></list-main>
        <a class=list-next data-list-replace>Next</a>
        <a class=list-prev data-list-replace>Prev</a>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    var n = this.currentScript.querySelector ('.list-next');
    var p = this.currentScript.querySelector ('.list-prev');
    return this.wait (100).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '1');
      this.assert.equal (items[1].textContent, '2');
      this.assert.equal (n.href, 'javascript:');
      this.assert.equal (n.hidden, true);
      this.assert.equal (p.href, 'javascript:');
      this.assert.equal (p.hidden, true);
      n.click ();
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '1');
      this.assert.equal (items[1].textContent, '2');
      p.click ();
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '1');
      this.assert.equal (items[1].textContent, '2');
    });
  </test-code>
  
  <test-code name="paging button">
    /*
      <list-container loader=pagingLoader key=data>
        <template><span data-field=value></span></template>
        <list-main></list-main>
        <button class=list-next data-list-replace>Next</button>
        <button class=list-prev data-list-replace>Prev</button>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    var n = this.currentScript.querySelector ('.list-next');
    var p = this.currentScript.querySelector ('.list-prev');
    return this.wait (100).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '1');
      this.assert.equal (items[1].textContent, '2');
      this.assert.equal (n.href, undefined);
      this.assert.equal (n.hidden, false);
      this.assert.equal (p.href, undefined);
      this.assert.equal (p.hidden, true);
      n.click ();
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '3');
      this.assert.equal (items[1].textContent, '4');
      p.click ();
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '-3');
      this.assert.equal (items[1].textContent, '-2');
    });
  </test-code>
  
  <test-code name="loadPrev / loadNext">
    /*
      <list-container loader=pagingLoader key=data>
        <template><span data-field=value></span></template>
        <list-main></list-main>
        <button class=list-next>Next</button>
        <button class=list-prev>Prev</button>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    var n = this.currentScript.querySelector ('.list-next');
    var p = this.currentScript.querySelector ('.list-prev');
    return this.wait (100).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '1');
      this.assert.equal (items[1].textContent, '2');
      this.assert.equal (n.href, undefined);
      this.assert.equal (n.hidden, false);
      this.assert.equal (p.href, undefined);
      this.assert.equal (p.hidden, true);
      e.loadNext ({replace: true});
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '3');
      this.assert.equal (items[1].textContent, '4');
      e.loadPrev ({replace: true});
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '-3');
      this.assert.equal (items[1].textContent, '-2');
    });
  </test-code>
  
  <test-code name="paging append/prepend">
    /*
      <list-container loader=pagingAppendLoader key=data>
        <template><span data-field=value></span></template>
        <list-main></list-main>
        <button class=list-next>Next</button>
        <button class=list-prev>Prev</button>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    var n = this.currentScript.querySelector ('.list-next');
    var p = this.currentScript.querySelector ('.list-prev');
    return this.wait (100).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '1');
      this.assert.equal (items[1].textContent, '2');
      n.click ();
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 4);
      this.assert.equal (items[0].textContent, '1');
      this.assert.equal (items[1].textContent, '2');
      this.assert.equal (items[2].textContent, '3');
      this.assert.equal (items[3].textContent, '4');
      p.click ();
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 6);
      this.assert.equal (items[0].textContent, '0');
      this.assert.equal (items[1].textContent, '-1');
      this.assert.equal (items[2].textContent, '1');
      this.assert.equal (items[3].textContent, '2');
      this.assert.equal (items[4].textContent, '3');
      this.assert.equal (items[5].textContent, '4');
    });
  </test-code>
  
  <test-code name="paging append/prepend with reverse">
    /*
      <list-container loader=pagingAppendLoader key=data reverse>
        <template><span data-field=value></span></template>
        <list-main></list-main>
        <button class=list-next>Next</button>
        <button class=list-prev>Prev</button>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    var n = this.currentScript.querySelector ('.list-next');
    var p = this.currentScript.querySelector ('.list-prev');
    return this.wait (100).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '2');
      this.assert.equal (items[1].textContent, '1');
      n.click ();
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 4);
      this.assert.equal (items[0].textContent, '4');
      this.assert.equal (items[1].textContent, '3');
      this.assert.equal (items[2].textContent, '2');
      this.assert.equal (items[3].textContent, '1');
      p.click ();
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 6);
      this.assert.equal (items[0].textContent, '4');
      this.assert.equal (items[1].textContent, '3');
      this.assert.equal (items[2].textContent, '2');
      this.assert.equal (items[3].textContent, '1');
      this.assert.equal (items[4].textContent, '-1');
      this.assert.equal (items[5].textContent, '0');
    });
  </test-code>
  
  <test-code name="paging append/prepend and scroll position">
    /*
      <list-container loader=pagingAppendLoader key=data>
        <template class=display-block><span data-field=value></span></template>
        <list-main></list-main>
        <button class=list-next data-list-scroll=preserve>Next</button>
        <button class=list-prev data-list-scroll=preserve>Prev</button>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    var n = this.currentScript.querySelector ('.list-next');
    var p = this.currentScript.querySelector ('.list-prev');
    var top0;
    return this.wait (100).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '1');
      this.assert.equal (items[1].textContent, '2');
      top0 = items[0].getBoundingClientRect ().top;
      n.click ();
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 4);
      this.assert.equal (items[0].textContent, '1');
      this.assert.equal (items[1].textContent, '2');
      this.assert.equal (items[2].textContent, '3');
      this.assert.equal (items[3].textContent, '4');
      this.assert.equal (items[0].getBoundingClientRect ().top, top0);
      p.click ();
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 6);
      this.assert.equal (items[0].textContent, '0');
      this.assert.equal (items[1].textContent, '-1');
      this.assert.equal (items[2].textContent, '1');
      this.assert.equal (items[3].textContent, '2');
      this.assert.equal (items[4].textContent, '3');
      this.assert.equal (items[5].textContent, '4');
      this.assert.equal (items[2].getBoundingClientRect ().top, top0);
    });
  </test-code>

  <script>
    var handler = document.createElementNS ('data:,pc', 'loader');
    handler.setAttribute ('name', 'localLoader');
    handler.pcHandler = function (opts) {
      return JSON.parse (this.querySelector ('loader-data').textContent);
    };
    document.head.appendChild (handler);
  </script>

  <test-code name="type=table">
    /*
      <list-container loader=localLoader type=table>
        <loader-data>
          {"data": [{"name": "a"}, {"name": "b"}]}
        </loader-data>
        <template><td data-field=name></template>
        <list-main></list-main>
        <table>
          <thead>
            <tr>
              <th>Name
          <tbody>
          <tbody>
        </table>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    this.assert.equal (e.querySelector ('list-main').children.length, 0);
    this.assert.equal (e.querySelector ('tbody:nth-of-type(1)').children.length, 2);
    var row1 = e.querySelector ('tbody > :nth-child(1)');
    this.assert.equal (row1.localName, 'tr');
    this.assert.equal (row1.innerHTML, '&lt;td data-field="name">a&lt;/td>');
    var row2 = e.querySelector ('tbody > :nth-child(2)');
    this.assert.equal (row2.localName, 'tr');
    this.assert.equal (row2.innerHTML, '&lt;td data-field="name">b&lt;/td>');
    this.assert.equal (e.querySelector ('tbody:nth-of-type(2)').children.length, 0);
  </test-code>

  <test-code name="type=table tbody appended later">
    /*
      <list-container loader=localLoader type=table>
        <loader-data>
          {"data": [{"name": "a"}, {"name": "b"}]}
        </loader-data>
        <template><td data-field=name></template>
        <list-main></list-main>
        <table>
          <thead>
            <tr>
              <th>Name
        </table>
        <ul></ul>
        <ol></ol>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    var tbody = document.createElement ('tbody');
    e.querySelector ('table').appendChild (tbody);
    await this.wait (300);
    this.assert.equal (e.querySelector ('list-main').children.length, 0);
    this.assert.equal (e.querySelector ('tbody').children.length, 2);
  </test-code>

  <test-code name="type=ul">
    /*
      <list-container loader=localLoader type=ul>
        <loader-data>
          {"data": [{"name": "a"}, {"name": "b"}]}
        </loader-data>
        <template><span data-field=name></span></template>
        <list-main></list-main>
        <table>
          <thead>
            <tr>
              <th>Name
          <tbody>
          <tbody>
        </table>
        <ul></ul>
        <ol></ol>
        <ul></ul>
        <ol></ol>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    this.assert.equal (e.querySelector ('list-main').children.length, 0);
    this.assert.equal (e.querySelector ('tbody:nth-of-type(1)').children.length, 0);
    this.assert.equal (e.querySelector ('tbody:nth-of-type(2)').children.length, 0);
    this.assert.equal (e.querySelector ('ul:nth-of-type(1)').children.length, 2);
    this.assert.equal (e.querySelector ('ol:nth-of-type(1)').children.length, 0);
    this.assert.equal (e.querySelector ('ul:nth-of-type(2)').children.length, 0);
    this.assert.equal (e.querySelector ('ol:nth-of-type(2)').children.length, 0);
    var row1 = e.querySelector ('ul > :nth-child(1)');
    this.assert.equal (row1.localName, 'li');
    this.assert.equal (row1.innerHTML, '&lt;span data-field="name">a&lt;/span>');
    var row2 = e.querySelector ('ul > :nth-child(2)');
    this.assert.equal (row2.localName, 'li');
    this.assert.equal (row2.innerHTML, '&lt;span data-field="name">b&lt;/span>');
  </test-code>

  <test-code name="type=ol">
    /*
      <list-container loader=localLoader type=ol>
        <loader-data>
          {"data": [{"name": "a"}, {"name": "b"}]}
        </loader-data>
        <template><span data-field=name></span></template>
        <list-main></list-main>
        <table>
          <thead>
            <tr>
              <th>Name
          <tbody>
          <tbody>
        </table>
        <ul></ul>
        <ol></ol>
        <ul></ul>
        <ol></ol>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    this.assert.equal (e.querySelector ('list-main').children.length, 0);
    this.assert.equal (e.querySelector ('tbody:nth-of-type(1)').children.length, 0);
    this.assert.equal (e.querySelector ('tbody:nth-of-type(2)').children.length, 0);
    this.assert.equal (e.querySelector ('ul').children.length, 0);
    this.assert.equal (e.querySelector ('ol').children.length, 2);
    this.assert.equal (e.querySelector ('ul:nth-of-type(2)').children.length, 0);
    this.assert.equal (e.querySelector ('ol:nth-of-type(2)').children.length, 0);
    var row1 = e.querySelector ('ol > :nth-child(1)');
    this.assert.equal (row1.localName, 'li');
    this.assert.equal (row1.innerHTML, '&lt;span data-field="name">a&lt;/span>');
    var row2 = e.querySelector ('ol > :nth-child(2)');
    this.assert.equal (row2.localName, 'li');
    this.assert.equal (row2.innerHTML, '&lt;span data-field="name">b&lt;/span>');
  </test-code>

  <test-code name="type=tab-set">
    /*
      <list-container loader=localLoader type=tab-set>
        <loader-data>
          {"data": [{"name": "a"}, {"name": "b"}]}
        </loader-data>
        <template><span data-field=name></span></template>
        <tab-set>
          <tab-menu></tab-menu>
        </tab-set>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    this.assert.equal (e.querySelector ('tab-set').children.length, 3);
    var menu = e.querySelector ('tab-menu');
    this.assert.equal (menu.children.length, 2);
    var row1 = e.querySelector ('tab-set > section:nth-of-type(1)');
    this.assert.equal (row1.innerHTML, '&lt;span data-field="name">a&lt;/span>');
    var row2 = e.querySelector ('tab-set > section:nth-of-type(2)');
    this.assert.equal (row2.innerHTML, '&lt;span data-field="name">b&lt;/span>');

    e.load ({});
    await this.wait (100);
    
    this.assert.equal (e.querySelector ('tab-set').children.length, 3);
    var menu = e.querySelector ('tab-menu');
    this.assert.equal (menu.children.length, 2);
  </test-code>

  <test-code name="type=select">
    /*
      <list-container loader=localLoader type=select>
        <loader-data>
          {"data": [{"name": "a"}, {"name": "b"}]}
        </loader-data>
        <template><span data-field=name></span></template>
        <list-main></list-main>
        <table>
          <thead>
            <tr>
              <th>Name
          <tbody>
          <tbody>
        </table>
        <ul></ul>
        <ol></ol>
        <ul></ul>
        <ol></ol>
        <select></select>
        <datalist></datalist>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    this.assert.equal (e.querySelector ('list-main').children.length, 0);
    this.assert.equal (e.querySelector ('tbody:nth-of-type(1)').children.length, 0);
    this.assert.equal (e.querySelector ('tbody:nth-of-type(2)').children.length, 0);
    this.assert.equal (e.querySelector ('ul').children.length, 0);
    this.assert.equal (e.querySelector ('ol').children.length, 0);
    this.assert.equal (e.querySelector ('ul:nth-of-type(2)').children.length, 0);
    this.assert.equal (e.querySelector ('ol:nth-of-type(2)').children.length, 0);
    this.assert.equal (e.querySelector ('select').children.length, 2);
    this.assert.equal (e.querySelector ('datalist').children.length, 0);
    var row1 = e.querySelector ('select > :nth-child(1)');
    this.assert.equal (row1.localName, 'option');
    this.assert.equal (row1.innerHTML, '&lt;span data-field="name">a&lt;/span>');
    var row2 = e.querySelector ('select > :nth-child(2)');
    this.assert.equal (row2.localName, 'option');
    this.assert.equal (row2.innerHTML, '&lt;span data-field="name">b&lt;/span>');
  </test-code>

  <test-code name="type=datalist">
    /*
      <list-container loader=localLoader type=datalist>
        <loader-data>
          {"data": [{"name": "a","text":"A"}, {"name": "b","text":"B"}]}
        </loader-data>
        <template data-filled=label data-label-field=text><span data-field=name></span></template>
        <list-main></list-main>
        <table>
          <thead>
            <tr>
              <th>Name
          <tbody>
          <tbody>
        </table>
        <ul></ul>
        <ol></ol>
        <ul></ul>
        <ol></ol>
        <select></select>
        <datalist></datalist>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    this.assert.equal (e.querySelector ('list-main').children.length, 0);
    this.assert.equal (e.querySelector ('tbody:nth-of-type(1)').children.length, 0);
    this.assert.equal (e.querySelector ('tbody:nth-of-type(2)').children.length, 0);
    this.assert.equal (e.querySelector ('ul').children.length, 0);
    this.assert.equal (e.querySelector ('ol').children.length, 0);
    this.assert.equal (e.querySelector ('ul:nth-of-type(2)').children.length, 0);
    this.assert.equal (e.querySelector ('ol:nth-of-type(2)').children.length, 0);
    this.assert.equal (e.querySelector ('datalist').children.length, 2);
    this.assert.equal (e.querySelector ('select').children.length, 0);
    var row1 = e.querySelector ('datalist > :nth-child(1)');
    this.assert.equal (row1.localName, 'option');
    this.assert.equal (row1.outerHTML, '&lt;option label="A">&lt;span data-field="name">a&lt;/span>&lt;/option>');
    var row2 = e.querySelector ('datalist > :nth-child(2)');
    this.assert.equal (row2.localName, 'option');
    this.assert.equal (row2.outerHTML, '&lt;option label="B">&lt;span data-field="name">b&lt;/span>&lt;/option>');
  </test-code>

  <test-code name="filter">
    /*
      <list-container loader=localLoader filter=testFilter1>
        <loader-data>
          {"values": [{"name": "a"}, {"name": "b"}]}
        </loader-data>
        <template><p data-field=value></template>
        <list-main></list-main>
        <script>
          var handler = document.createElementNS ('data:,pc', 'filter');
          handler.setAttribute ('name', 'testFilter1');
          handler.pcHandler = function (data) {
            var newList = data.values.map ((i) => {return {value: i.name}});
            newList.push ({value: "c"});
            return {data: newList};
          };
          document.head.appendChild (handler);
        </script>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    var list = e.querySelector ('list-main');
    this.assert.equal (list.children.length, 3);
    this.assert.equal (list.children[0].textContent, 'a');
    this.assert.equal (list.children[1].textContent, 'b');
    this.assert.equal (list.children[2].textContent, 'c');
  </test-code>

  <test-code name="default filter object to list">
    /*
      <list-container loader=localLoader>
        <loader-data>
          {"data": {"A": {"name": "a"}}}
        </loader-data>
        <template><p data-field=name></template>
        <list-main></list-main>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    var list = e.querySelector ('list-main');
    this.assert.equal (list.children.length, 1);
    this.assert.equal (list.children[0].textContent, 'a');
  </test-code>

  <test-code name="default filter reverse">
    /*
      <list-container loader=localLoader reverse>
        <loader-data>
          {"data": [{"name": "a"}, {"name": "b"}, {"name": "c"}]}
        </loader-data>
        <template><p data-field=name></template>
        <list-main></list-main>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    var list = e.querySelector ('list-main');
    this.assert.equal (list.children.length, 3);
    this.assert.equal (list.children[0].textContent, 'c');
    this.assert.equal (list.children[1].textContent, 'b');
    this.assert.equal (list.children[2].textContent, 'a');
  </test-code>

  <test-code name="list-is-empty">
    /*
      <section hidden>
      <list-container loader=localLoader>
        <loader-data>
          {"data": [{"name": "a"}, {"name": "b"}, {"name": "c"}]}
        </loader-data>
        <template><p data-field=name></template>
        <list-is-empty>A</list-is-empty>
        <list-main></list-main>
        <list-is-empty>B</list-is-empty>
      </list-container>
      </section>
    */
    var e = this.currentScript.querySelector ('list-container');
    this.assert.equal (e.querySelectorAll ('list-is-empty')[0].hidden, true);
    this.assert.equal (e.querySelectorAll ('list-is-empty')[1].hidden, true);
    this.assert.equal (e.hidden, false);
    this.assert.equal (e.parentNode.hidden, true);
  </test-code>

  <test-code name="list-is-empty empty">
    /*
      <section>
      <list-container loader=localLoader>
        <loader-data>
          {"data": []}
        </loader-data>
        <template><p data-field=name></template>
        <list-is-empty>A</list-is-empty>
        <list-main></list-main>
        <list-is-empty>B</list-is-empty>
      </list-container>
      </section>
    */
    var e = this.currentScript.querySelector ('list-container');
    this.assert.equal (e.querySelectorAll ('list-is-empty')[0].hidden, false);
    this.assert.equal (e.querySelectorAll ('list-is-empty')[1].hidden, false);
    this.assert.equal (e.hidden, false);
    this.assert.equal (e.parentNode.hidden, false);
  </test-code>

  <test-code name="parent section">
    /*
      <section hidden>
      <list-container loader=localLoader hascontainer>
        <loader-data>
          {"data": [{"name": "a"}, {"name": "b"}, {"name": "c"}]}
        </loader-data>
        <template><p data-field=name></template>
        <list-is-empty>A</list-is-empty>
        <list-main></list-main>
        <list-is-empty>B</list-is-empty>
      </list-container>
      </section>
    */
    var e = this.currentScript.querySelector ('list-container');
    this.assert.equal (e.querySelectorAll ('list-is-empty')[0].hidden, true);
    this.assert.equal (e.querySelectorAll ('list-is-empty')[1].hidden, true);
    this.assert.equal (e.hidden, false);
    this.assert.equal (e.parentNode.hidden, false, e.parentNode.localName);
  </test-code>

  <test-code name="parent section empty">
    /*
      <section><div>
      <list-container loader=localLoader hascontainer>
        <loader-data>
          {"data": []}
        </loader-data>
        <template><p data-field=name></template>
        <list-is-empty>A</list-is-empty>
        <list-main></list-main>
        <list-is-empty>B</list-is-empty>
      </list-container>
      </div></section>
    */
    var e = this.currentScript.querySelector ('list-container');
    this.assert.equal (e.querySelectorAll ('list-is-empty')[0].hidden, false);
    this.assert.equal (e.querySelectorAll ('list-is-empty')[1].hidden, false);
    this.assert.equal (e.hidden, false);
    this.assert.equal (e.parentNode.hidden, false);
    this.assert.equal (e.parentNode.parentNode.hidden, true);
  </test-code>

  <test-code name="template-set">
    /*
      <list-container loader=localLoader template=templateSet1>
        <loader-data>
          {"data": [{"name":1},{"name":2}]}
        </loader-data>
        <list-main></list-main>
      </list-container>
      <template-set name=templateSet1>
        <template>a<span data-field=name></span>b</template>
      </template-set>
    */
    var e = this.currentScript.querySelector ('list-container');
    await this.wait ();
    var list = e.querySelector ('list-main');
    this.assert.equal (list.children.length, 2);
    this.assert.equal (list.textContent, 'a1ba2b');
  </test-code>

  <test-code name="list-container pcRendered">
    /*
      <list-container loader=pcRenderedTestLoader>
        <template><p data-field=name></template>
        <list-main></list-main>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');

    var invoked = false;
    var target;
    this.currentScript.addEventListener ('pcRendered', (ev) => {
      invoked = true;
      target = ev.target;
    });

    var handler = document.createElementNS ('data:,pc', 'loader');
    handler.setAttribute ('name', 'pcRenderedTestLoader');
      handler.pcHandler = function (opts) {
      return {data: []};
    };
    document.head.appendChild (handler);

    await this.wait (100);

    this.assert.equal (invoked, true);
    this.assert.equal (target, e);
  </test-code>

  <test-code name="list-container pcRendered with item">
    /*
      <list-container loader=pcRenderedTestLoader2>
        <template><p data-field=name></template>
        <list-main></list-main>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');

    var invoked = false;
    var target;
    this.currentScript.addEventListener ('pcRendered', (ev) => {
      invoked = true;
      target = ev.target;
    });

    var handler = document.createElementNS ('data:,pc', 'loader');
    handler.setAttribute ('name', 'pcRenderedTestLoader2');
      handler.pcHandler = function (opts) {
      return {data: [{name: "item1"}, {name: "item2"}]};
    };
    document.head.appendChild (handler);

    await this.wait (100);

    this.assert.equal (invoked, true);
    this.assert.equal (target, e);
    this.assert.equal (target.querySelector ('list-main').textContent, 'item1item2');
  </test-code>

  <test-code name="pcRendered event 3">
    /*
      <list-container loader=pcTestLoader3>
        <template><p data-field=name></template>
        <list-main></list-main>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');

    var invoked = 0;
    var target;
    this.currentScript.querySelector ('list-container').addEventListener ('pcRendered', (ev) => {
      invoked++;
      target = ev.target;
    });

    var data = [{name: "item1"}, {name: "item2"}];
    
    var handler = document.createElementNS ('data:,pc', 'loader');
    handler.setAttribute ('name', 'pcTestLoader3');
      handler.pcHandler = function (opts) {
      return {data: data};
    };
    document.head.appendChild (handler);

    await this.wait (100);

    this.assert.equal (invoked, 1);
    this.assert.equal (target, e);
    this.assert.equal (target.querySelector ('list-main').textContent, 'item1item2');

    var data = [{name: "item2"}, {name: "item1"}];
    e.load ({});
    
    await this.wait (100);

    this.assert.equal (invoked, 2);
    this.assert.equal (target, e);
    this.assert.equal (target.querySelector ('list-main').textContent, 'item2item1');
  </test-code>

  <test-code name="autoreload">
    /*
      <list-container loader=localLoader autoreload>
        <loader-data>
          {"data": [{"name": "x"}, {"name": "y"}]}
        </loader-data>
        <template><p data-field=name></template>
        <list-main></list-main>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    var list = e.querySelector ('list-main');
    this.assert.equal (list.children.length, 2);
    this.assert.equal (list.children[0].textContent, 'x');
    this.assert.equal (list.children[1].textContent, 'y');

    var data = this.currentScript.querySelector ('loader-data');
    data.textContent = '{"data": [{"name": "a"}, {"name": "b"}, {"name": "c"}]}';

    await new Promise (ok => {
      var timer = setInterval (() => {
        if (list.textContent.match (/a/)) {
          ok ();
          clearTimeout (timer);
        }
      }, 1000);
    });
      
    this.assert.equal (list.children.length, 3);
    this.assert.equal (list.children[0].textContent, 'a');
    this.assert.equal (list.children[1].textContent, 'b');
    this.assert.equal (list.children[2].textContent, 'c');
  </test-code>

  <script>
    var handler = document.createElementNS ('data:,pc', 'loader');
    handler.setAttribute ('name', 'localPagedLoader');
    handler.pcHandler = function (opts) {
      var data = JSON.parse (document.querySelector ('local-paged-loader-data').textContent);
      return data[opts.ref || ''] || {data: []};
    };
    document.head.appendChild (handler);
  </script>
  
  <local-paged-loader-data style="display:none">
        {
          "-z": {"data": [{"name": "y2"}, {"name": "y1"}],
                 "reversed": true,
                 "next": {"ref": "-y", "has": true},
                 "prev": {"ref": "+y", "has": false}},
          "-a": {"data": [{"name": "z2"}, {"name": "z1"}],
                 "reversed": true,
                 "next": {"ref": "-z", "has": true},
                 "prev": {"ref": "+z", "has": true}},
          "+y": {"data": [{"name": "z1"}, {"name": "z2"}],
                 "next": {"ref": "+z", "has": true},
                 "prev": {"ref": "-z", "has": true}},
          "": {"data": [{"name": "a1"}, {"name": "a2"}],
               "next": {"ref": "+a", "has": true},
               "prev": {"ref": "-a", "has": true}},
          "+z": {"data": [{"name": "a1"}, {"name": "a2"}],
                 "next": {"ref": "+a", "has": true},
                 "prev": {"ref": "-a", "has": true}},
          "-b": {"data": [{"name": "a2"}, {"name": "a1"}],
                 "reversed": true,
                 "next": {"ref": "-a", "has": true},
                 "prev": {"ref": "+a", "has": true}},
          "+a": {"data": [{"name": "b1"}, {"name": "b2"}],
                 "next": {"ref": "+b", "has": true},
                 "prev": {"ref": "-b", "has": true}},
          "-c": {"data": [{"name": "b2"}, {"name": "b1"}],
                 "reversed": true,
                 "next": {"ref": "-b", "has": true},
                 "prev": {"ref": "+b", "has": true}},
          "+b": {"data": [{"name": "c1"}, {"name": "c2"}],
                 "next": {"ref": "+c", "has": false},
                 "prev": {"ref": "-c", "has": true}}
        }
  </local-paged-loader-data>

  <test-code name="pager prev/next pages">
    /*
      <list-container loader=localPagedLoader>
        <template>[<span data-field=name></span>]</template>
        <button type=button class=list-prev>Previous page</button>
        <list-main></list-main>
        <button type=button class=list-next>Next page</button>
      </list-container>
    */

    var list = this.currentScript.querySelector ('list-container');
    var lm = list.querySelector ('list-main');

    this.assert.equal (lm.textContent, '[a1][a2]');
    this.assert.equal (list.querySelector ('.list-prev').offsetWidth > 0, true);
    this.assert.equal (list.querySelector ('.list-next').offsetWidth > 0, true);

    list.querySelector ('.list-prev').click ();
    await this.wait (100);

    this.assert.equal (lm.textContent, '[z1][z2][a1][a2]');
    this.assert.equal (list.querySelector ('.list-prev').offsetWidth > 0, true);
    this.assert.equal (list.querySelector ('.list-next').offsetWidth > 0, true);

    list.querySelector ('.list-prev').click ();
    await this.wait (100);

    this.assert.equal (lm.textContent, '[y1][y2][z1][z2][a1][a2]');
    this.assert.equal (list.querySelector ('.list-prev').offsetWidth > 0, true);
    this.assert.equal (list.querySelector ('.list-next').offsetWidth > 0, true);

    list.querySelector ('.list-prev').click ();
    await this.wait (100);

    this.assert.equal (lm.textContent, '[y1][y2][z1][z2][a1][a2]');
    this.assert.equal (list.querySelector ('.list-prev').offsetWidth, 0);
    this.assert.equal (list.querySelector ('.list-next').offsetWidth > 0, true);

    list.querySelector ('.list-next').click ();
    await this.wait (100);

    this.assert.equal (lm.textContent, '[y1][y2][z1][z2][a1][a2][b1][b2]');
    this.assert.equal (list.querySelector ('.list-prev').offsetWidth, 0);
    this.assert.equal (list.querySelector ('.list-next').offsetWidth > 0, true);

    list.querySelector ('.list-next').click ();
    await this.wait (100);

    this.assert.equal (lm.textContent, '[y1][y2][z1][z2][a1][a2][b1][b2][c1][c2]');
    this.assert.equal (list.querySelector ('.list-prev').offsetWidth, 0);
    this.assert.equal (list.querySelector ('.list-next').offsetWidth, 0);
  </test-code>

  <test-code name="reload-button">
    /*
      <list-container loader=localLoader>
        <loader-data>
          {"data": [{"name": "x"}, {"name": "y"}]}
        </loader-data>
        <template><p data-field=name></template>
        <list-main></list-main>
        <button type=button class=list-reload>Reload</button>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    var list = e.querySelector ('list-main');
    this.assert.equal (list.children.length, 2);
    list.textContent = '';

    e.querySelector ('.list-reload').click ();
    await this.wait (100);

    this.assert.equal (list.children.length, 2);
    this.assert.equal (list.children[0].textContent, 'x');
    this.assert.equal (list.children[1].textContent, 'y');
  </test-code>

  <test-code name="template data-filled zero">
    /*
      <list-container loader=localLoader type=datalist>
        <loader-data>
          {"data": [{"name": "a","text":"A"}, {"name": "b","text":"B"}]}
        </loader-data>
        <template data-filled=label data-id-field=text><span data-field=name></span></template>
        <datalist></datalist>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    this.assert.equal (e.querySelector ('datalist').children.length, 2);
    var row1 = e.querySelector ('datalist > :nth-child(1)');
    this.assert.equal (row1.localName, 'option');
    this.assert.equal (row1.outerHTML, '&lt;option id="A">&lt;span data-field="name">a&lt;/span>&lt;/option>');
    var row2 = e.querySelector ('datalist > :nth-child(2)');
    this.assert.equal (row2.localName, 'option');
    this.assert.equal (row2.outerHTML, '&lt;option id="B">&lt;span data-field="name">b&lt;/span>&lt;/option>');
  </test-code>
  
  <test-code name="loader abort 1">
    /*
      <list-container loader=abortTestLoader1>
        <template><p data-field=name></template>
        <list-main></list-main>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');

    var signals = [];
    var handler = document.createElementNS ('data:,pc', 'loader');
    handler.setAttribute ('name', 'abortTestLoader1');
    handler.pcHandler = async (opts) => {
      signals.push (opts.signal);
      await this.wait (opts.wait);
      return {data: [{name: "item1:" + opts.wait}]};
    };
    document.head.appendChild (handler);

    e.load ({wait: 3000});
    e.load ({wait: 2000});
    e.load ({wait: 1000});
    
    await this.wait (4000);

    var lm = this.currentScript.querySelector ('list-main');
    this.assert.equal (lm.textContent, 'item1:1000');
    this.assert.equal (signals.length >= 1, true);
    this.assert.equal (signals[signals.length-1].aborted, false);
  </test-code>
  
  <test-code name="loader abort 2">
    /*
      <list-container loader=abortTestLoader2>
        <template><p data-field=name></template>
        <list-main></list-main>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');

    var signals = [];
    var handler = document.createElementNS ('data:,pc', 'loader');
    handler.setAttribute ('name', 'abortTestLoader2');
    handler.pcHandler = async (opts) => {
      signals.push (opts.signal);
      await this.wait (opts.wait);
      return {data: [{name: "item1:" + opts.wait}]};
    };
    document.head.appendChild (handler);

    e.load ({wait: 3000});
    await this.wait (1000);
    e.load ({wait: 2000});
    await this.wait (1000);
    e.load ({wait: 1000});
    await this.wait (2000);

    var lm = this.currentScript.querySelector ('list-main');
    this.assert.equal (lm.textContent, 'item1:1000');
    this.assert.equal (signals.length >= 3, true);
    this.assert.equal (signals[signals.length-3].aborted, true);
    this.assert.equal (signals[signals.length-2].aborted, true);
    this.assert.equal (signals[signals.length-1].aborted, false);
  </test-code>
  
  <test-code name="loader abort 3">
    /*
      <list-container loader=abortTestLoader3 filter=abortTestFilter3>
        <template><p data-field=name></template>
        <list-main></list-main>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');

    var handler = document.createElementNS ('data:,pc', 'loader');
    handler.setAttribute ('name', 'abortTestLoader3');
    handler.pcHandler = async (opts) => {
      return {data: [{name: "item1:" + opts.wait}]};
    };
    document.head.appendChild (handler);
    
    var signals = [];
    var handler = document.createElementNS ('data:,pc', 'filter');
    handler.setAttribute ('name', 'abortTestFilter3');
    handler.pcHandler = async (results, opts) => {
      signals.push (opts.signal);
      await this.wait (opts.wait);
      return results;
    };
    document.head.appendChild (handler);

    e.load ({wait: 3000});
    await this.wait (1000);
    e.load ({wait: 2000});
    await this.wait (1000);
    e.load ({wait: 1000});
    await this.wait (2000);

    var lm = this.currentScript.querySelector ('list-main');
    this.assert.equal (lm.textContent, 'item1:1000');
    this.assert.equal (signals.length >= 3, true);
    this.assert.equal (signals[signals.length-3].aborted, true);
    this.assert.equal (signals[signals.length-2].aborted, true);
    this.assert.equal (signals[signals.length-1].aborted, false);
  </test-code>

  <script src=runtests.js></script>
</body>
</html>
<!--

Per CC0 <https://creativecommons.org/publicdomain/zero/1.0/>, to the
extent possible under law, the author has waived all copyright and
related or neighboring rights to this work.

-->
