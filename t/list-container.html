<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Test</title>
</head>
<body>
  <test-code name="empty">
    // <list-container>hoge</list-container>
    var e = this.currentScript.querySelector ('list-container');
    this.assert.equal (e.innerHTML, 'hoge');
  </test-code>
  
  <test-code name="loader not defined">
    // <list-container loader=abcde>hoge</list-container>
    var e = this.currentScript.querySelector ('list-container');
    this.assert.equal (e.innerHTML, 'hoge');
  </test-code>
  
  <test-code name="loader defined after upgrade">
    /*
      <list-container loader=loaderDefinedAfterUpgrade>
        <template><span data-field=name></span></template>
        <list-main></list-main>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    var handler = document.createElementNS ('data:,pc', 'loader');
    handler.setAttribute ('name', 'loaderDefinedAfterUpgrade');
    handler.pcHandler = () => {
      return {data: [{"name":"a"}, {"name":"c"}]};
    };
    document.head.appendChild (handler);
    return this.wait (100).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, 'a');
      this.assert.equal (items[1].textContent, 'c');
    });
  </test-code>
  
  <test-code name="loader defined before upgrade">
    /*
      <template>
        <template><span data-field=name></span></template>
        <list-main></list-main>
      </template>
    */
    var handler = document.createElementNS ('data:,pc', 'loader');
    handler.setAttribute ('name', 'loaderDefinedBeforeUpgrade');
    handler.pcHandler = () => {
      return {data: [{"name":"a"}, {"name":"c"}]};
    };
    document.head.appendChild (handler);

    var e = document.createElement ('list-container');
    e.setAttribute ('loader', 'loaderDefinedBeforeUpgrade');
    var f = this.currentScript.querySelector ('template');
    e.appendChild (f.content);
    this.currentScript.appendChild (e);
    
    return this.wait (100).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, 'a');
      this.assert.equal (items[1].textContent, 'c');
    });
  </test-code>
  
  <test-code name="list-main inserted later">
    /*
      <template>
        <template><span data-field=name></span></template>
      </template>
    */
    var handlerName = Math.random ();
    var handler = document.createElementNS ('data:,pc', 'loader');
    handler.setAttribute ('name', handlerName);
    handler.pcHandler = () => {
      return {data: [{"name":"aa"}, {"name":"cc"}]};
    };
    document.head.appendChild (handler);

    var e = document.createElement ('list-container');
    e.setAttribute ('loader', handlerName);
    var f = this.currentScript.querySelector ('template');
    e.appendChild (f.content);
    this.currentScript.appendChild (e);
    
    return this.wait ().then (() => {
      var insertionPoint = document.createElement ('list-main');
      e.appendChild (insertionPoint);
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, 'aa');
      this.assert.equal (items[1].textContent, 'cc');
    });
  </test-code>
  
  <test-code name="list-main inserted later (descendant)">
    /*
      <template>
        <template>[[<span data-field=name></span>]]</template>
      </template>
    */
    var handlerName = Math.random ();
    var handler = document.createElementNS ('data:,pc', 'loader');
    handler.setAttribute ('name', handlerName);
    handler.pcHandler = () => {
      return {data: [{"name":"aa"}, {"name":"cc"}]};
    };
    document.head.appendChild (handler);

    var e = document.createElement ('list-container');
    e.setAttribute ('loader', handlerName);
    var f = this.currentScript.querySelector ('template');
    e.appendChild (f.content);
    this.currentScript.appendChild (e);
    
    return this.wait ().then (() => {
      var insertionPoint = document.createElement ('list-main');
      var g = document.createElement ('div');
      g.appendChild (insertionPoint);
      e.appendChild (g);
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '[[aa]]');
      this.assert.equal (items[1].textContent, '[[cc]]');
    });
  </test-code>
  
  <test-code name="renderingrequires filltype">
    /*
      <list-container loader=renderingRequiresTestLoader>
        <template data-requires=filltype:e-1><e-1 data-field=name></e-1></template>
        <list-main></list-main>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    var handler = document.createElementNS ('data:,pc', 'loader');
    handler.setAttribute ('name', 'renderingRequiresTestLoader');
    handler.pcHandler = () => {
      return {data: [{"name":"a"}, {"name":"c"}]};
    };
    document.head.appendChild (handler);

    return this.wait (100).then (() => {
      var f = document.createElementNS ('data:,pc', 'filltype');
      f.setAttribute ('name', 'e-1');
      f.setAttribute ('content', 'contentattribute');
      document.head.appendChild (f);
      
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '');
      this.assert.equal (items[0].firstChild.getAttribute ('value'), 'a', 'value=""');
      this.assert.equal (items[1].textContent, '');
      this.assert.equal (items[1].firstChild.getAttribute ('value'), 'c', 'value=""');
    });
  </test-code>
  
  <test-code name="src">
    /*
      <list-container src=list-container-data-1.json key=abc>
        <template><span data-field=name></span></template>
        <list-main></list-main>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    return this.wait ().then (() => {
      return e.loaded;
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, 'A.');
      this.assert.equal (items[1].textContent, 'B.');
    });
  </test-code>
  
  <test-code name="src no key">
    /*
      <list-container src=list-container-data-1.json>
        <template><span data-field=name></span></template>
        <list-main></list-main>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    return this.wait ().then (() => {
      return e.loaded;
    }).then (() => {
      throw "e.loaded not failed";
    }, (error) => {  
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 0);
      this.assertEqualError (error, new Error ("|key| is not specified"));
    });
  </test-code>
  
  <test-code name="src bad json">
    /*
      <list-container src=data:,null key=abc>
        <template><span data-field=name></span></template>
        <list-main></list-main>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    return this.wait ().then (() => {
      return e.loaded;
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 0);
    });
  </test-code>

  <script>
    var handler = document.createElementNS ('data:,pc', 'loader');
    handler.setAttribute ('name', 'pagingLoader');
    handler.pcHandler = (opts) => {
      var ref = parseFloat (opts.ref);
      if (!Number.isFinite (ref)) ref = 0;
      return {
        data: [{"value":++ref}, {"value": ++ref}],
        next: {ref: ref, has: true},
        prev: {ref: ref-4, has: false},
      };
    };
    document.head.appendChild (handler);
  </script>
  <script>
    var handler = document.createElementNS ('data:,pc', 'loader');
    handler.setAttribute ('name', 'pagingNoPageLoader');
    handler.pcHandler = (opts) => {
      var ref = parseFloat (opts.ref);
      if (!Number.isFinite (ref)) ref = 0;
      return {
        data: [{"value":++ref}, {"value": ++ref}],
      };
    };
    document.head.appendChild (handler);
  </script>

  <script>
    var handler = document.createElementNS ('data:,pc', 'loader');
    handler.setAttribute ('name', 'pagingAppendLoader');
    handler.pcHandler = (opts) => {
      var ref = parseFloat (opts.ref);
      if (!Number.isFinite (ref)) ref = 0;
      return {
        data: [{"value":++ref}, {"value": ++ref}],
        next: {ref: ref, has: true, append: true},
        prev: {ref: ref-4, has: false, prepend: true},
      };
    };
    document.head.appendChild (handler);
  </script>
  
  <test-code name="paging">
    /*
      <list-container loader=pagingLoader key=data>
        <template><span data-field=value></span></template>
        <list-main></list-main>
        <a class=list-next>Next</a>
        <a class=list-prev>Prev</a>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    var n = this.currentScript.querySelector ('.list-next');
    var p = this.currentScript.querySelector ('.list-prev');
    return this.wait (100).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '1');
      this.assert.equal (items[1].textContent, '2');
      this.assert.equal (n.href, 'javascript:');
      this.assert.equal (n.hidden, false);
      this.assert.equal (p.href, 'javascript:');
      this.assert.equal (p.hidden, true);
      n.click ();
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '3');
      this.assert.equal (items[1].textContent, '4');
      p.click ();
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '1');
      this.assert.equal (items[1].textContent, '2');
      p.click ();
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '-1');
      this.assert.equal (items[1].textContent, '0');
    });
  </test-code>
  
  <test-code name="paging no page data">
    /*
      <list-container loader=pagingNoPageLoader key=data>
        <template><span data-field=value></span></template>
        <list-main></list-main>
        <a class=list-next>Next</a>
        <a class=list-prev>Prev</a>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    var n = this.currentScript.querySelector ('.list-next');
    var p = this.currentScript.querySelector ('.list-prev');
    return this.wait (100).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '1');
      this.assert.equal (items[1].textContent, '2');
      this.assert.equal (n.href, 'javascript:');
      this.assert.equal (n.hidden, true);
      this.assert.equal (p.href, 'javascript:');
      this.assert.equal (p.hidden, true);
      n.click ();
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '1');
      this.assert.equal (items[1].textContent, '2');
      p.click ();
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '1');
      this.assert.equal (items[1].textContent, '2');
    });
  </test-code>
  
  <test-code name="paging button">
    /*
      <list-container loader=pagingLoader key=data>
        <template><span data-field=value></span></template>
        <list-main></list-main>
        <button class=list-next>Next</button>
        <button class=list-prev>Prev</button>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    var n = this.currentScript.querySelector ('.list-next');
    var p = this.currentScript.querySelector ('.list-prev');
    return this.wait (100).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '1');
      this.assert.equal (items[1].textContent, '2');
      this.assert.equal (n.href, undefined);
      this.assert.equal (n.hidden, false);
      this.assert.equal (p.href, undefined);
      this.assert.equal (p.hidden, true);
      n.click ();
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '3');
      this.assert.equal (items[1].textContent, '4');
      p.click ();
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '1');
      this.assert.equal (items[1].textContent, '2');
    });
  </test-code>
  
  <test-code name="paging append/prepend">
    /*
      <list-container loader=pagingAppendLoader key=data>
        <template><span data-field=value></span></template>
        <list-main></list-main>
        <button class=list-next>Next</button>
        <button class=list-prev>Prev</button>
      </list-container>
    */
    var e = this.currentScript.querySelector ('list-container');
    var n = this.currentScript.querySelector ('.list-next');
    var p = this.currentScript.querySelector ('.list-prev');
    return this.wait (100).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 2);
      this.assert.equal (items[0].textContent, '1');
      this.assert.equal (items[1].textContent, '2');
      n.click ();
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 4);
      this.assert.equal (items[0].textContent, '1');
      this.assert.equal (items[1].textContent, '2');
      this.assert.equal (items[2].textContent, '3');
      this.assert.equal (items[3].textContent, '4');
      p.click ();
      return this.wait (100);
    }).then (() => {
      var items = e.querySelectorAll ('list-main list-item');
      this.assert.equal (items.length, 6);
      this.assert.equal (items[0].textContent, '0');
      this.assert.equal (items[1].textContent, '-1');
      this.assert.equal (items[2].textContent, '1');
      this.assert.equal (items[3].textContent, '2');
      this.assert.equal (items[4].textContent, '3');
      this.assert.equal (items[5].textContent, '4');
    });
  </test-code>

  <script src=runtests.js></script>
</body>
</html>
<!--

Per CC0 <https://creativecommons.org/publicdomain/zero/1.0/>, to the
extent possible under law, the author has waived all copyright and
related or neighboring rights to this work.

-->
